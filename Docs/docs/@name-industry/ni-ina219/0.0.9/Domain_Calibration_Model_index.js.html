<!DOCTYPE html>
<html lang="en">
<head>
    
    <meta charset="utf-8">
    <title>Domain/Calibration/Model/index.js - Documentation</title>
    
    
    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css">
    <script src="scripts/nav.js" defer></script>
    
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav >
    
    
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="BaseRegisterModel.html">BaseRegisterModel</a><ul class='methods'><li data-type='method'><a href="BaseRegisterModel.html#.formatData#formatData">formatData</a></li><li data-type='method'><a href="BaseRegisterModel.html#.getCurrentValues#getCurrentValues">getCurrentValues</a></li><li data-type='method'><a href="BaseRegisterModel.html#.getCurrentValues#getCurrentValues">getCurrentValues</a></li><li data-type='method'><a href="BaseRegisterModel.html#.hydrate#hydrate">hydrate</a></li></ul></li><li><a href="BusVoltage.html">BusVoltage</a></li><li><a href="BusVoltageModel.html">BusVoltageModel</a><ul class='methods'><li data-type='method'><a href="BusVoltageModel.html#.calculateValue#calculateValue">calculateValue</a></li></ul></li><li><a href="Calibration.html">Calibration</a><ul class='methods'><li data-type='method'><a href="Calibration.html#.getCalculationValues#getCalculationValues">getCalculationValues</a></li><li data-type='method'><a href="Calibration.html#.getCalibration#getCalibration">getCalibration</a></li><li data-type='method'><a href="Calibration.html#.setCalibrationByTemplate#setCalibrationByTemplate">setCalibrationByTemplate</a></li><li data-type='method'><a href="Calibration.html#.setCustomCalibration#setCustomCalibration">setCustomCalibration</a></li><li data-type='method'><a href="Calibration.html#.triggerCalibration#triggerCalibration">triggerCalibration</a></li></ul></li><li><a href="CalibrationModel.html">CalibrationModel</a><ul class='methods'><li data-type='method'><a href="CalibrationModel.html#.getCalibrationValues#getCalibrationValues">getCalibrationValues</a></li><li data-type='method'><a href="CalibrationModel.html#.setActiveTemplate#setActiveTemplate">setActiveTemplate</a></li><li data-type='method'><a href="CalibrationModel.html#.setCustomCalibrationValues#setCustomCalibrationValues">setCustomCalibrationValues</a></li></ul></li><li><a href="ChargeRemainingModel.html">ChargeRemainingModel</a><ul class='methods'><li data-type='method'><a href="ChargeRemainingModel.html#.calculateValue#calculateValue">calculateValue</a></li><li data-type='method'><a href="ChargeRemainingModel.html#.formatData#formatData">formatData</a></li></ul></li><li><a href="Configuration.html">Configuration</a><ul class='methods'><li data-type='method'><a href="Configuration.html#.getConfiguration#getConfiguration">getConfiguration</a></li><li data-type='method'><a href="Configuration.html#.setConfiguration#setConfiguration">setConfiguration</a></li><li data-type='method'><a href="Configuration.html#.setConfigurationBADC#setConfigurationBADC">setConfigurationBADC</a></li><li data-type='method'><a href="Configuration.html#.setConfigurationByTemplate#setConfigurationByTemplate">setConfigurationByTemplate</a></li><li data-type='method'><a href="Configuration.html#.setConfigurationMode#setConfigurationMode">setConfigurationMode</a></li><li data-type='method'><a href="Configuration.html#.setConfigurationMode#setConfigurationMode">setConfigurationMode</a></li><li data-type='method'><a href="Configuration.html#.setConfigurationPGA#setConfigurationPGA">setConfigurationPGA</a></li><li data-type='method'><a href="Configuration.html#.setConfigurationSADC#setConfigurationSADC">setConfigurationSADC</a></li></ul></li><li><a href="ConfigurationModel.html">ConfigurationModel</a><ul class='methods'><li data-type='method'><a href="ConfigurationModel.html#.editConfigurationBADC#editConfigurationBADC">editConfigurationBADC</a></li><li data-type='method'><a href="ConfigurationModel.html#.editConfigurationBRNG#editConfigurationBRNG">editConfigurationBRNG</a></li><li data-type='method'><a href="ConfigurationModel.html#.editConfigurationMode#editConfigurationMode">editConfigurationMode</a></li><li data-type='method'><a href="ConfigurationModel.html#.editConfigurationPGain#editConfigurationPGain">editConfigurationPGain</a></li><li data-type='method'><a href="ConfigurationModel.html#.editConfigurationSADC#editConfigurationSADC">editConfigurationSADC</a></li><li data-type='method'><a href="ConfigurationModel.html#.getCurrentConfiguration#getCurrentConfiguration">getCurrentConfiguration</a></li><li data-type='method'><a href="ConfigurationModel.html#.setActiveTemplate#setActiveTemplate">setActiveTemplate</a></li></ul></li><li><a href="Current.html">Current</a></li><li><a href="CurrentModel.html">CurrentModel</a><ul class='methods'><li data-type='method'><a href="CurrentModel.html#.calculateValue#calculateValue">calculateValue</a></li></ul></li><li><a href="Device.html">Device</a><ul class='methods'><li data-type='method'><a href="Device.html#.getDeviceInformation#getDeviceInformation">getDeviceInformation</a></li><li data-type='method'><a href="Device.html#.initialize#initialize">initialize</a></li></ul></li><li><a href="I2cBus.html">I2cBus</a><ul class='methods'><li data-type='method'><a href="I2cBus.html#.getConnectedDevices#getConnectedDevices">getConnectedDevices</a></li><li data-type='method'><a href="I2cBus.html#.initialize#initialize">initialize</a></li><li data-type='method'><a href="I2cBus.html#.readRegister#readRegister">readRegister</a></li><li data-type='method'><a href="I2cBus.html#.updateState#updateState">updateState</a></li><li data-type='method'><a href="I2cBus.html#.writeRegister#writeRegister">writeRegister</a></li></ul></li><li><a href="NI_INA219.html">NI_INA219</a><ul class='methods'><li data-type='method'><a href="NI_INA219.html#.getBusVoltage#getBusVoltage">getBusVoltage</a></li><li data-type='method'><a href="NI_INA219.html#.getCalibration#getCalibration">getCalibration</a></li><li data-type='method'><a href="NI_INA219.html#.getChargeRemaining#getChargeRemaining">getChargeRemaining</a></li><li data-type='method'><a href="NI_INA219.html#.getConfiguration#getConfiguration">getConfiguration</a></li><li data-type='method'><a href="NI_INA219.html#.getCurrent#getCurrent">getCurrent</a></li><li data-type='method'><a href="NI_INA219.html#.getDeviceInformation#getDeviceInformation">getDeviceInformation</a></li><li data-type='method'><a href="NI_INA219.html#.getPower#getPower">getPower</a></li><li data-type='method'><a href="NI_INA219.html#.getPowerSupplyVoltage#getPowerSupplyVoltage">getPowerSupplyVoltage</a></li><li data-type='method'><a href="NI_INA219.html#.getShuntVoltage#getShuntVoltage">getShuntVoltage</a></li><li data-type='method'><a href="NI_INA219.html#.initialize#initialize">initialize</a></li><li data-type='method'><a href="NI_INA219.html#.setConfigurationByTemplateId#setConfigurationByTemplateId">setConfigurationByTemplateId</a></li></ul></li><li><a href="Power.html">Power</a></li><li><a href="PowerModel.html">PowerModel</a><ul class='methods'><li data-type='method'><a href="PowerModel.html#.calculateValue#calculateValue">calculateValue</a></li></ul></li><li><a href="PowerSupplyModel.html">PowerSupplyModel</a><ul class='methods'><li data-type='method'><a href="PowerSupplyModel.html#.calculateValue#calculateValue">calculateValue</a></li><li data-type='method'><a href="PowerSupplyModel.html#.formatData#formatData">formatData</a></li></ul></li><li><a href="ShuntVoltage.html">ShuntVoltage</a></li><li><a href="ShuntVoltageModel.html">ShuntVoltageModel</a><ul class='methods'><li data-type='method'><a href="ShuntVoltageModel.html#.calculateValue#calculateValue">calculateValue</a></li></ul></li><li><a href="Utilities.html">Utilities</a><ul class='methods'><li data-type='method'><a href="Utilities.html#.mappedLabelsAndBits#mappedLabelsAndBits">mappedLabelsAndBits</a></li><li data-type='method'><a href="Utilities.html#.registerAsBinaryString#registerAsBinaryString">registerAsBinaryString</a></li></ul></li><li><a href="WSchargeRemaining.html">WSchargeRemaining</a></li><li><a href="WSpowerSupplyVoltage.html">WSpowerSupplyVoltage</a></li></ul><h3>Global</h3><ul><li><a href="global.html#TEMPLATES">TEMPLATES</a></li></ul>
    
</nav>

<div id="main">
    
    <h1 class="page-title">Domain/Calibration/Model/index.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * @class CalibrationModel
 * 
 * @summary
 * CALIBRATION REGISTER: PDF REF: Figure 27 pg. 24
 * @description
 * Current and Power calibration settings. 
 * &lt;br />&lt;br />
 * BIT 0: void&lt;br />
 *  this bit is not used and cant be set.
 * &lt;br />&lt;br />
 * BIT 15 - 1: settings&lt;br />
 *  Full scale range, LSB or current and power, and overall system calibration
 */

import BaseRegisterModel from "../../BaseModels/BaseRegisterModel.js";
import Big from "big.js";

class CalibrationModel extends BaseRegisterModel {

    /** @type {object | undefined} */
    activeTemplate;

    /** @type {number} */
    currentLSB = 0;

    /** @type {number} */
    currentLSB_R = 0;

    /** @type {number} */
    powerLSB = 0;

    /** @type {number} */
    calculationValue = 0;

    /** @type {number} */
    calculationValue_R = 0;

    constructor() {
        super("Calibration");
    }

    /**
     * @type {object}
     * 
     * @summary
     * If useFullReturn is true then the labels are added to the return
     * object. 
     * 
     * @description
     * These are labels the directly match the reference sensor PDF doc. When
     * debugging or in case UI desires it, arrays of labels and bits in the 
     * register will be matched.
     */
    bitLabels = [
        'FS15', 'FS14', 'FS13', 'FS12', 'FS11', 'FS10',
        'FS9', 'FS8', 'FS7', 'FS6', 'FS5', 'FS4', 'FS3',
        'FS2', 'FS1', 'FS0'
    ];

    /**
     * @type {object}
     * 
     * @summary
     * the type of value in the register
     * 
     * @description
     * Currently only english language value types
     */
    measurement = {
        en: {}
    }

    /**
     * @method CalibrationModel#getCalibrationValues
     * 
     * @summary
     * EXPERIMENTAL: calculate system calc values
     * 
     * @description
     * Expose shunt value and calculation values to tune
     * system measurements.
     * 
     * @returns {Object} returns calibration values
     */
    getCalibrationValues = function () {
        return {
            currentLSB: this.currentLSB,
            currentLSB_R: this.currentLSB_R,
            powerLSB: this.powerLSB,
            calculationValue: this.calculationValue,
            calculationValue_R: this.calculationValue_R
        }
    }

    /**
     * @method CalibrationModel#setActiveTemplate
     * 
     * @summary
     * Sets active Template 
     * 
     * @description
     * Set the active template internally if using templates.
     * 
     * @param {number} newCalibration calibration register as an int
     * @returns {object} currently active template
     */
    setActiveTemplate = function (template) {
        if (template !== undefined) {
            this.activeTemplate = template;
        } else {
            this.activeTemplate = undefined; // unset
        }
        return {
            activeTemplate: this.activeTemplate || {}
        }
    }

    getActiveTemplate = function () {
        return {
            activeTemplate: this.activeTemplate || {}
        }
    }

    /**
     * @method CalibrationModel#setCustomCalibrationValues
     * 
     * @summary
     * EXPERIMENTAL: calculate system calc values
     * 
     * @description
     * Expose shunt value and calculation values to tune
     * system measurements.
     * 
     * @param {number} busVoltageMax 
     * @param {number} shuntResistanceOhms 
     * @param {number} gainVoltage 
     * @param {number} currentMaxExpected 
     * 
     * @returns {Object} returns calibration values
     */
    setCustomCalibrationValues = function (
        busVoltageMax,
        shuntResistanceOhms,
        gainVoltage,
        currentMaxExpected
    ) {

        // Convert all values to High Resolution Big-Js number objects;
        let gainVoltageHR = new Big(gainVoltage);
        let shuntResistanceOhmsHR = new Big(shuntResistanceOhms);
        let currentMaxExpectedHR = new Big(currentMaxExpected);
        let max15BitValue = new Big(2).pow(15);
        let max12BitValue = new Big(2).pow(12);

        // BUS_VOLTAGE_RANGE as Volts
        // RANGE_16V || RANGE_32V
        // 16 || 32
        // - busVoltageMax;

        // SHUNT_VALUE as OHMS passed in by hand not in config
        // 0.1
        // - shuntResistanceOhms;

        // GAIN as Volts
        // DIV_1_40MV || DIV_2_80MV || DIV_4_160MV || DIV_8_320MV
        // 0.04 || 0.08 || 0.16 || 0.32
        // - gainVoltage

        // Maximum current calc
        // gainVoltage / shuntResistanceOhms
        let currentMax = gainVoltageHR.div(shuntResistanceOhmsHR).toNumber();

        // For tuning should be rounding between these two values.
        // ----------------------------------
        // Minimum LSB 15 bits 
        // results in uA per bit
        // currentMaxExpected / Math.pow(2,15)
        let minimumLSB = currentMaxExpectedHR.div(max15BitValue).toNumber();

        // Maximum LSB 12 bit
        // results in uA per bit
        // currentMaxExpected / Math.pow(2,12)
        let maximumLSB = currentMaxExpectedHR.div(max12BitValue).toNumber();
        // ----------------------------------

        // page 12 in the ina219 pdf "8.5.1 Programming the Calibration Register"
        // ...While this value yields the highest resolution, 
        // it is common to select a value for the Current_LSB to 
        // the nearest round number above this value to simplify the 
        // conversion of the Current Register (04h) and 
        // Power Register (03h) to amperes and watts respectively

        // I am not rounding it here. 1 way to round it is look at
        // maximumLSB and round up - all other libs seem to use 0.1
        // this is essentially minimumLSB
        let currentLSB = currentMaxExpectedHR.div(max15BitValue).toNumber();

        // Attempt at rounding the currentLSB
        let currentLSB_R = new Big(currentLSB).round(5, 1).toNumber();

        // trunc prior to assign
        // #note: 0.04096 is an internal fixed value in ina219
        let calculationValue = new Big(0.04096 / (currentLSB * shuntResistanceOhmsHR)).round(0, 0).toNumber();
        let calculationValue_R = new Big(0.04096 / (currentLSB_R * shuntResistanceOhmsHR)).round(0, 0).toNumber();

        // 20 is an internal fixed value in ina219
        let powerLSB = currentLSB * 20;

        // update internal values
        this.currentLSB = currentLSB;
        this.currentLSB_R = currentLSB_R;
        this.powerLSB = powerLSB;
        this.calculationValue = calculationValue;
        this.calculationValue_R = calculationValue_R;

        // send back results in case needed
        return {
            currentLSB,
            currentLSB_R,
            powerLSB,
            calculationValue,
            calculationValue_R
        }

    }

}

export default new CalibrationModel();</code></pre>
        </article>
    </section>




    
    
</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.6.11</a> on Sat Dec 03 2022 18:09:20 GMT-0500 (Eastern Standard Time) using the <a href="https://github.com/clenemt/docdash">docdash</a> theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/polyfill.js"></script>
<script src="scripts/linenumber.js"></script>



</body>
</html>
